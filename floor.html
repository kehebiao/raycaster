<!doctype html>
<html>
  <head>
    <title>Fast Raycaster w/ Floor/Ceiling Texturing</title>
  </head>

  <body>
    <canvas id="canvas" width="512" height="512">
    </canvas>

    <script type="text/javascript">
      var canvas = document.getElementById ("canvas"),
          ctx = canvas.getContext ("2d"),
          id = ctx.getImageData (0, 0, canvas.width, canvas.height)

      /* FIXME: We can optimize a vertical strip raycaster by just casting
       * against the floor and checking for a wall at each pixel. There are
       * lots of possible optimizations, like only checking for a new wall
       * after we cross a threshold, etc. */
      function draw (id) {
        var width = id.width,
            height = id.height,
            data = id.data,
            x, y, i, j

        var a, b, c

        for (x = 0; x !== width; ++x) {
          i = x << 2
          j = (height - 1) * width *4 + i
          
          for (y = 0; y !== height * 0.5; ++y) {
            c = 256 / (1 - y * 2 / height)
            a = x / width - 0.5
            b = 1 / Math.sqrt (a * a + 1)
            a *= b

            a *= c
            b *= c

            a &= 255
            b &= 255

            data[i    ] =
            data[i + 1] =
            data[i + 2] = a ^ b
            data[i + 3] = 255

            data[j    ] =
            data[j + 1] =
            data[j + 2] = a ^ b
            data[j + 3] = 255

            i += width << 2
            j -= width << 2
          }
        }
      }

      draw (id)
      ctx.putImageData (id, 0, 0)
    </script>
  </body>
</html>
