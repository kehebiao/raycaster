<!doctype html>
<html>
  <head>
    <title>Fast Raycaster w/ Floor/Ceiling Texturing</title>
  </head>

  <body>
    <canvas id="canvas" width="512" height="512">
    </canvas>

    <p id="debug"></p>

    <script type="text/javascript">
      var canvas = document.getElementById ("canvas"),
          debug = document.getElementById ("debug"),
          ctx = canvas.getContext ("2d"),
          id = ctx.getImageData (0, 0, canvas.width, canvas.height)

      /* FIXME: We can optimize a vertical strip raycaster by just casting
       * against the floor and checking for a wall at each pixel. There are
       * lots of possible optimizations, like only checking for a new wall
       * after we cross a threshold, etc. */
      function draw (id, cx, cy, ca) {
        var width = id.width,
            height = id.height,
            data = id.data,
            cos = Math.cos (ca),
            sin = Math.sin (ca),
            invWidth = 1 / width,
            invHeight = 1 / height,
            x, tx, y, ty, i, t, u, v

        i = data.length
        while (i--) {
          data[i] = 0
          i -= 3
        }

        i = data.length
        y = height >> 1
        ty = 0.5
        while (y--) {
          ty -= invHeight
          t = 64 / ty
          x = width
          tx = 0.5
          while (x--) {
            tx -= invWidth
            u = cx + (tx * cos - sin) * t
            v = cy + (cos + tx * sin) * t

            if (u < 0 || u >= 4096 || v < 0 || v >= 4096) {
              /* FIXME: Loop vertically, drawing a wall. */
              data[--i] = 255
              data[--i] =
              data[--i] =
              data[--i] = 0
            }

            else if (!data[--i]) {
              data[i] = 255
              data[--i] =
              data[--i] =
              data[--i] = (u ^ v) & 255
            }
          }

          /* FIXME: If an entire row is filled already, break the loop. */
        }
      }

      var start = Date.now (),
          frame = 0

      setInterval (function () {
        frame++
        var millis = Date.now () - start

        draw (id, 2048, 2048, millis * Math.PI / 8000)
        ctx.putImageData (id, 0, 0)
      }, 0)

      setInterval (function () {
        debug.innerHTML = Math.round (frame * 1000 / (Date.now () - start)) + " FPS"
      }, 1000)
    </script>
  </body>
</html>
