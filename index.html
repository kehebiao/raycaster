<html>
  <head>
    <style type="text/css">
      * {
        margin: 0;
        padding: 0;
        border: 0;
      }

      body {
        overflow: hidden;
      }

      #debug {
        position: absolute;
        left: 1em;
        top: 1em;
      }
    </style>
  </head>

  <body>
    <canvas id="canvas" width="0" height="0"></canvas>
    <p id="debug"></p>

    <script type="text/javascript">
      var wall,
          side,
          dist

      var colors = ["red", "green", "blue", "purple"]

      function raycast (x, y, a, b, c) {
        var sx = 1 / (c * a - b),
            sy = 1 / (a + c * b),
            zx, zy, ox, oy

        a = x
        b = y
        x |= 0
        y |= 0

        if (sx > 0) { zx = (x + 1 - a) * sx; a = 1; ox = 0 }
        else { sx = -sx; zx = (a - x) * sx; a = -1; ox = 2 }

        if (sy > 0) { zy = (y + 1 - b) * sy; b = 15; oy = 3 }
        else { sy = -sy; zy = (b - y) * sy; b = -15; oy = 1 }
        y *= 15

        for (;;)
          if (zx < zy) {
            x += a
            c = x + y

            if (map[c]) {
              wall = c
              side = ox
              dist = zx
              return
            }

            zx += sx
          }

          else {
            y += b
            c = x + y

            if (map[c]) {
              wall = c
              side = oy
              dist = zy
              return
            }

            zy += sy
          }
      }
      
      function draw (x, y, a) {
        var cos = Math.cos (a),
            sin = Math.sin (a),
            a = 1 / width,
            b = width * 0.5,
            lWall, lSide, lDist

        function recurse (l, lWall, lSide, lDist, r, rWall, rSide, rDist) {
          var m, mWall, mSide, mDist

          while ((lWall !== rWall || lSide !== rSide) && r - l !== 1) {
            m = (l + r) >> 1

            raycast (x, y, cos, sin, m * a - 0.5)
            mWall = wall
            mSide = side
            mDist = dist

            recurse (l, lWall, lSide, lDist, m, mWall, mSide, mDist)

            l = m
            lWall = mWall
            lSide = mSide
            lDist = mDist
          }

          /* FIXME: Change this to iterating over scanlines. */
          lDist = b / lDist
          rDist = b / rDist

          ctx.fillStyle = colors[lSide]
          ctx.beginPath ()
          ctx.moveTo (l,  lDist)
          ctx.lineTo (l, -lDist)
          ctx.lineTo (r, -rDist)
          ctx.lineTo (r,  rDist)
          ctx.fill ()
        }

        ctx.save ()
        ctx.clearRect (0, 0, width, height)
        ctx.translate (0, height * 0.5)

        raycast (x, y, cos, sin, -0.5)
        lWall = wall; lSide = side; lDist = dist
        raycast (x, y, cos, sin, 0.5)
        recurse (0, lWall, lSide, lDist, width, wall, side, dist)

        ctx.restore ()
      }

      var canvas = document.getElementById ("canvas"),
          debug = document.getElementById ("debug"),
          width = canvas.width,
          height = canvas.height,
          ctx = canvas.getContext ("2d"),
          map = [
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
          ]

      function resize () {
        canvas.width = width = document.body.clientWidth
        canvas.height = height = document.body.clientHeight
      }

      resize ()
      window.onresize = resize

      var start = Date.now (),
          frame = 0

      setInterval (function () {
        var millis = Date.now () - start
        frame++

        draw (7.5, 7.5, millis * Math.PI / 16000)

        if (frame % 60 === 1)
          debug.innerHTML = Math.floor (frame * 1000 / millis) + " FPS"
      }, 0)
    </script>
  </body>
</html>
