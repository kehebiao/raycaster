<html>
  <head>
  </head>

  <body>
    <canvas id="canvas" width="640" height="640">
    </canvas>

    <script type="text/javascript">
      var wall,
          side,
          dist

      var colors = ["red", "green", "blue", "purple"]

      function raycast (x, y, a, b, dx) {
        var sx = 1 / (dx * a - b),
            sy = 1 / (a + dx * b),
            zx, zy, ox, oy

        a = x
        b = y
        x |= 0
        y |= 0

        if (sx > 0) { zx = (x + 1 - a) * sx; a = 1; ox = 0 }
        else { sx = -sx; zx = (a - x) * sx; a = -1; ox = 2 }

        if (sy > 0) { zy = (y + 1 - b) * sy; b = 15; oy = 3 }
        else { sy = -sy; zy = (b - y) * sy; b = -15; oy = 1 }
        y *= 15

        for (;;)
          if (zx < zy) {
            x += a

            if (map[x + y]) {
              wall = x + y
              side = ox
              dist = zx
              return
            }

            zx += sx
          }

          else {
            y += b

            if (map[x + y]) {
              wall = x + y
              side = oy
              dist = zy
              return
            }

            zy += sy
          }
      }
      
      function draw (ctx, x, y, a) {
        var cos = Math.cos (a),
            sin = Math.sin (a),
            w = ctx.canvas.width,
            h = ctx.canvas.height,
            i = w

        ctx.clearRect (0, 0, i, h)
        ctx.save ()
        ctx.translate (0, h * 0.5)

        while (i--) {
          raycast (x, y, cos, sin, (i + 0.5) / w - 0.5)

          h = w / dist
          ctx.fillStyle = colors[side]
          ctx.fillRect (i, h * -0.5, 1, h)
        }

        ctx.restore ()
      }

      var canvas = document.getElementById ("canvas"),
          ctx = canvas.getContext ("2d"),
          map = [
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
          ],
          start = Date.now ()

      setInterval (function () {
        var millis = Date.now () - start

        draw (ctx, 7.5, 7.5, millis * Math.PI / 8000)
      }, 0)
    </script>
  </body>
</html>
