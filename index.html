<html>
  <head>
    <style type="text/css">
      * {
        margin: 0;
        padding: 0;
        border: 0;
      }

      body {
        overflow: hidden;
      }
    </style>
  </head>

  <body>
    <canvas id="canvas" width="0" height="0"></canvas>

    <script type="text/javascript">
      var wall,
          side,
          dist

      var colors = ["red", "green", "blue", "purple"]

      function raycast (x, y, a, b, c) {
        var sx = 1 / (c * a - b),
            sy = 1 / (a + c * b),
            zx, zy, ox, oy

        a = x
        b = y
        x |= 0
        y |= 0

        if (sx > 0) { zx = (x + 1 - a) * sx; a = 1; ox = 0 }
        else { sx = -sx; zx = (a - x) * sx; a = -1; ox = 2 }

        if (sy > 0) { zy = (y + 1 - b) * sy; b = 15; oy = 3 }
        else { sy = -sy; zy = (b - y) * sy; b = -15; oy = 1 }
        y *= 15

        for (;;)
          if (zx < zy) {
            x += a
            c = x + y

            if (map[c]) {
              wall = c
              side = ox
              dist = zx
              return
            }

            zx += sx
          }

          else {
            y += b
            c = x + y

            if (map[c]) {
              wall = c
              side = oy
              dist = zy
              return
            }

            zy += sy
          }
      }
      
      function recurse (ctx, x, y, cos, sin, l, lWall, lSide, lDist, r, rWall, rSide, rDist) {
        var m, mWall, mSide, mDist

        while (r - l !== 1 && (lWall !== rWall || lSide !== rSide)) {
          m = (l + r) >> 1

          raycast (x, y, cos, sin, (m + 0.5) / ctx.canvas.width - 0.5)
          mWall = wall
          mSide = side
          mDist = dist

          recurse (ctx, x, y, cos, sin, l, lWall, lSide, lDist, m, mWall, mSide, mDist)

          l = m
          lWall = mWall
          lSide = mSide
          lDist = mDist
        }

        lDist = ctx.canvas.width * 0.5 / lDist
        rDist = ctx.canvas.width * 0.5 / rDist

        ctx.strokeStyle = colors[lSide]
        ctx.beginPath ()
        ctx.moveTo (l,  lDist)
        ctx.lineTo (l, -lDist)
        ctx.lineTo (r, -rDist)
        ctx.lineTo (r,  rDist)
        ctx.closePath ()
        ctx.stroke ()
      }

      function draw (ctx, x, y, a) {
        var cos = Math.cos (a),
            sin = Math.sin (a),
            w = ctx.canvas.width,
            h = ctx.canvas.height,
            i = w

        ctx.save ()
        ctx.clearRect (0, 0, w, h)
        ctx.translate (0, h * 0.5)

        raycast (x, y, cos, sin, -0.5)

        var lWall = wall,
            lSide = side,
            lDist = dist

        raycast (x, y, cos, sin, 0.5)

        recurse (ctx, x, y, cos, sin, 0, lWall, lSide, lDist, w, wall, side, dist)
        /*
        while (i--) {
          raycast (x, y, cos, sin, (i + 0.5) / w - 0.5)

          h = w / dist
          ctx.fillStyle = colors[side]
          ctx.fillRect (i, h * -0.5, 1, h)
        }
        */

        ctx.restore ()
      }

      var canvas = document.getElementById ("canvas"),
          ctx = canvas.getContext ("2d"),
          map = [
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
          ],
          start = Date.now ()

      function resize () {
        canvas.width = document.body.clientWidth
        canvas.height = document.body.clientHeight
      }

      resize ()
      window.onresize = resize

      setInterval (function () {
        var millis = Date.now () - start
        draw (ctx, 7.5, 7.5, millis * Math.PI / 8000)
      }, 0)
    </script>
  </body>
</html>
